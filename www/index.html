<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>rasterVis</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="title" content="rasterVis"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2013-01-10 18:01:10 CET"/>
<meta name="author" content="Oscar Perpiñán Lamigueiro"/>
<meta name="description" content="rasterVis"/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="styles.css" />
<script type="text/javascript">
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">rasterVis</h1>


<p>
The <a href="http://cran.r-project.org/web/packages/raster/index.html">raster</a> package defines classes and methods for spatial raster data
access and manipulation. The <code>rasterVis</code> package complements
raster providing a set of methods for enhanced visualization and
interaction. The stable release of <code>rasterVis</code> can be found at
<a href="http://cran.r-project.org/web/packages/rasterVis/">CRAN</a>. The development version is at <a href="https://r-forge.r-project.org/R/?group_id=1129">R-Forge</a>.
</p>
<p>
This page has been generated with <a href="http://orgmode.org/">org-mode</a>. You can download the <a href="http://rastervis.r-forge.r-project.org/index.org">org file</a> and the <a href="http://rastervis.r-forge.r-project.org/index.R">R code</a>.
</p>
<p>
Let's show some of its functionalities with some examples, using data
from the
<a href="http://www.cmsaf.eu/bvbw/appmanager/bvbw/cmsafInternet">CMSAF</a>
project as described
<a href="http://procomun.wordpress.com/2011/06/17/raster-cmsaf-and-solar/">here</a>
(<a href="http://www.box.net/shared/rl51y1t9sldxk54ogd44">download data</a>).
</p>



<pre class="src src-R"><span class="org-constant">library</span>(raster)
<span class="org-constant">library</span>(rasterVis)

<span class="org-comment-delimiter">##</span><span class="org-comment">change to your folder...</span>
old <span class="org-constant">&lt;-</span> setwd(<span class="org-string">'~/Datos/CMSAF'</span>)
listFich <span class="org-constant">&lt;-</span> dir(pattern=<span class="org-string">'2008'</span>)
stackSIS <span class="org-constant">&lt;-</span> stack(listFich)
stackSIS <span class="org-constant">&lt;-</span> stackSIS*24 <span class="org-comment-delimiter">##</span><span class="org-comment">from irradiance (W/m2) to irradiation Wh/m2</span>
setwd(old)

idx <span class="org-constant">&lt;-</span> seq(as.Date(<span class="org-string">'2008-01-15'</span>), as.Date(<span class="org-string">'2008-12-15'</span>), <span class="org-string">'month'</span>)

SISmm <span class="org-constant">&lt;-</span> setZ(stackSIS, idx)
names(SISmm) <span class="org-constant">&lt;-</span> month.abb

</pre>



<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#levelplot">Level plots</a></li>
<li><a href="#themes">Themes</a></li>
<li><a href="#scatterplot">Scatterplots and histograms</a></li>
<li><a href="#spacetime">Space-time plots</a></li>
<li><a href="#vectorplot">Vector field plots</a></li>
<li><a href="#interaction">Interaction</a></li>
</ul>
</div>
</div>

<div id="outline-container-levelplot" class="outline-2">
<h2 id="levelplot"><a name="sec-1" id="sec-1"></a>Level plots</h2>
<div class="outline-text-2" id="text-levelplot">


<p>
The first step is to display the content with a <code>levelplot</code>:
</p>



<pre class="src src-R">levelplot(SISmm)
</pre>


<p>
<img src="figs/levelplot.png"  alt="figs/levelplot.png" />
</p>
<p>
If only one layer is chosen, this method displays a marginal plot
of a function across each coordinate:
</p>



<pre class="src src-R">levelplot(SISmm, layers=1, FUN.margin=median, contour=<span class="org-type">TRUE</span>)
</pre>


<p>
<img src="figs/levelplot_layer1.png"  alt="figs/levelplot_layer1.png" />
</p>
<p>
The result of this call is a <code>trellis</code> object. The <a href="http://latticeextra.r-forge.r-project.org/">latticeExtra</a> package
provides the <code>layer</code> function to add contents. For example, let's add the administrative borders. 
This information is available at the <a href="http://www.gadm.org/data/shp/ESP_adm.zip">GADM service</a>.
</p>



<pre class="src src-R"><span class="org-constant">library</span>(maptools)
proj <span class="org-constant">&lt;-</span> CRS(<span class="org-string">'+proj=longlat +ellps=WGS84'</span>)
<span class="org-comment-delimiter">##</span><span class="org-comment">Change to your folder</span>
mapaSHP <span class="org-constant">&lt;-</span> readShapeLines(<span class="org-string">'~/Datos/ESP_adm/ESP_adm2.shp'</span>, proj4string=proj)

p <span class="org-constant">&lt;-</span> levelplot(SISmm, layers=1, FUN.margin=median)
p + layer(sp.lines(mapaSHP, lwd=0.8, col=<span class="org-string">'darkgray'</span>))
</pre>


<p>
<img src="figs/levelplot_layer_borders.png"  alt="figs/levelplot_layer_borders.png" />
</p>

</div>

<div id="outline-container-levelplot_logscale" class="outline-3">
<h3 id="levelplot_logscale"><a name="sec-1-1" id="sec-1-1"></a>Log scale</h3>
<div class="outline-text-3" id="text-levelplot_logscale">


<p>
The <code>zscaleLog</code> argument controls whether the object will be log
transformed before being passed to the panel function.  Defaults to
‘NULL’, in which case the Raster* is not transformed.  Other possible
values are any number that works as a base for taking logarithm,
‘TRUE’ (which is equivalent to 10), and ‘"e"’ (for the natural
logarithm).  As a side effect, the colorkey is labeled differently.
</p>



<pre class="src src-R">f <span class="org-constant">&lt;-</span> system.file(<span class="org-string">"external/test.grd"</span>, package=<span class="org-string">"raster"</span>)
r <span class="org-constant">&lt;-</span> raster(f)
levelplot(r^2, zscaleLog=<span class="org-type">TRUE</span>, contour=<span class="org-type">TRUE</span>)
</pre>


</div>
</div>

</div>

<div id="outline-container-themes" class="outline-2">
<h2 id="themes"><a name="sec-2" id="sec-2"></a>Themes</h2>
<div class="outline-text-2" id="text-themes">


<p>
The previous plots used the default theme of rasterVis,
<code>rasterTheme</code>. This theme defines a sequential palette with yellow,
orange and red. There are three more themes in <code>rasterVis</code>: <code>GrTheme</code>
(with a grey palette), <code>BTCTheme</code> (defined with the <code>BTC</code> palette of
the <code>hexbin</code> package) and <code>RdBuTheme</code> (with a diverging palette with
red and blue). 
</p>
<p>
The irradiation of August is:
</p>



<pre class="src src-R">Aug <span class="org-constant">&lt;-</span> raster(SISmm, 8)
</pre>


<p>
and its overall mean is calculated with cellStats:
</p>



<pre class="src src-R">meanAug <span class="org-constant">&lt;-</span> cellStats(Aug, mean)
</pre>


<p>
The diverging palette is specially well suited to this data:
</p>



<pre class="src src-R">levelplot(Aug-meanAug, par.settings=RdBuTheme)
</pre>


<p>
<img src="figs/levelplotAug.png"  alt="figs/levelplotAug.png" />
</p>
<p>
Besides, it is easy to define a new theme with a different
palette. For example, using a sequential palette from
<a href="http://cran.r-project.org/web/packages/colorspace">colorspace</a>:
</p>



<pre class="src src-R"><span class="org-constant">library</span>(colorspace)
myTheme=rasterTheme(region=sequential_hcl(10, power=2.2))
levelplot(Aug, par.settings=myTheme, contour=<span class="org-type">TRUE</span>)
</pre>


<p>
<img src="figs/levelplot_colorspace.png"  alt="figs/levelplot_colorspace.png" />
</p>
<p>
or with the colour-blindness corrections from the <a href="http://cran.r-project.org/web/packages/dichromat/">dichromat</a> package:
</p>



<pre class="src src-R"><span class="org-constant">library</span>(dichromat)
myTheme <span class="org-constant">&lt;-</span> rasterTheme(region=dichromat(terrain.colors(15)))
levelplot(Aug, par.settings=myTheme)
</pre>


<p>
<img src="figs/levelplot_dichromat.png"  alt="figs/levelplot_dichromat.png" />
</p>
</div>

</div>

<div id="outline-container-scatterplot" class="outline-2">
<h2 id="scatterplot"><a name="sec-3" id="sec-3"></a>Scatterplots and histograms</h2>
<div class="outline-text-2" id="text-scatterplot">


<p>
There are methods to show scatter plots and hexbin plots of the layers
and coordinates of a <code>Raster</code> object:
</p>



<pre class="src src-R"><span class="org-comment-delimiter">##</span><span class="org-comment">Relation between the January &amp; February versus July radiation for four</span>
<span class="org-comment-delimiter">##</span><span class="org-comment">differents longitude regions.</span>
xyplot(Jan+Feb~Jul|cut(x, 4), data=SISmm, auto.key=list(space=<span class="org-string">'right'</span>))
</pre>


<p>
<img src="figs/xyplot_formula.png"  alt="figs/xyplot_formula.png" />
</p>



<pre class="src src-R"><span class="org-comment-delimiter">##</span><span class="org-comment">Faster with hexbinplot</span>
hexbinplot(Jan~Jul|cut(x, 6), data=SISmm)
</pre>


<p>
<img src="figs/hexbinplot_formula.png"  alt="figs/hexbinplot_formula.png" />
</p>
<p>
&hellip;a method for scatter plot matrices:
</p>



<pre class="src src-R">splom(SISmm)
</pre>


<p>
<img src="figs/splom.png"  alt="figs/splom.png" />
</p>
<p>
..and methods for histograms, <a href="http://procomun.wordpress.com/2011/04/02/violin-plot/">box-and-whisker and violin</a> plots or density estimates:
</p>



<pre class="src src-R">histogram(SISmm)
</pre>


<p>
<img src="figs/histogram.png"  alt="figs/histogram.png" />
</p>



<pre class="src src-R">densityplot(SISmm)
</pre>


<p>
<img src="figs/density.png"  alt="figs/density.png" />
</p>



<pre class="src src-R">bwplot(SISmm)
</pre>


<p>
<img src="figs/bwplot.png"  alt="figs/bwplot.png" />
</p>
<p>
These methods accept a <code>FUN</code> argument to be applied to the <code>z</code> slot of
the <code>Raster</code> object. The result of this function is used as the grouping
variable of the plot:
</p>



<pre class="src src-R">histogram(SISmm, FUN=as.yearqtr)
</pre>


<p>
<img src="figs/histogram_FUN.png"  alt="figs/histogram_FUN.png" />
</p>
</div>

</div>

<div id="outline-container-spacetime" class="outline-2">
<h2 id="spacetime"><a name="sec-4" id="sec-4"></a>Space-time plots</h2>
<div class="outline-text-2" id="text-spacetime">


<p>
The <code>z</code> slot of this <code>Raster</code> object stores a time index. This 3D
space-time <code>Raster</code> object can be displayed with a <a href="http://en.wikipedia.org/wiki/Hovmoller_diagram">hovmoller diagram</a>.
</p>
<p>
The <code>hovmoller</code> method uses the function <code>xyLayer</code>, which creates a
<code>RasterLayer</code> from a function of the coordinates.
</p>



<pre class="src src-R">f <span class="org-constant">&lt;-</span> system.file(<span class="org-string">"external/test.grd"</span>, package=<span class="org-string">"raster"</span>)
r <span class="org-constant">&lt;-</span> raster(f)
dirXY <span class="org-constant">&lt;-</span>xyLayer(r, sqrt(x^2 + y^2))
dirXY
</pre>


<p>
For example, the next code builds a hovmoller diagram showing the
time evolution of the mean value along the latitude (data
available at
<a href="ftp://ftp.wiley.com/public/sci_tech_med/spatio_temporal_data/">ftp://ftp.wiley.com/public/sci_tech_med/spatio_temporal_data/</a>):
</p>



<pre class="src src-R"><span class="org-constant">library</span>(zoo)

url <span class="org-constant">&lt;-</span> <span class="org-string">"~/Datos/Cressie/"</span>
sst.dat = read.table(paste(url, <span class="org-string">"SST011970_032003.dat"</span>, sep=<span class="org-string">''</span>), header = <span class="org-type">FALSE</span>) 
sst.ll = read.table(paste(url, <span class="org-string">"SSTlonlat.dat"</span>, sep=<span class="org-string">''</span>), header = <span class="org-type">FALSE</span>)

spSST <span class="org-constant">&lt;-</span> SpatialPointsDataFrame(sst.ll, sst.dat)
gridded(spSST) <span class="org-constant">&lt;-</span> <span class="org-type">TRUE</span>
proj4string(spSST) = <span class="org-string">"+proj=longlat +datum=WGS84"</span>
SST <span class="org-constant">&lt;-</span> brick(spSST)

idx <span class="org-constant">&lt;-</span> seq(as.Date(<span class="org-string">'1970-01-01'</span>), as.Date(<span class="org-string">'2003-03-01'</span>), by=<span class="org-string">'month'</span>)
idx <span class="org-constant">&lt;-</span> as.yearmon(idx)
SST <span class="org-constant">&lt;-</span> setZ(SST, idx)
names(SST) <span class="org-constant">&lt;-</span> as.character(idx)
hovmoller(SST, contour=<span class="org-type">FALSE</span>, panel=panel.levelplot.raster,
          yscale.components=yscale.raster.subticks,
          interpolate=<span class="org-type">TRUE</span>, par.settings=RdBuTheme)
</pre>


<p>
<img src="figs/hovmoller.png"  alt="figs/hovmoller.png" />
</p>
<p>
The <code>horizonplot</code> and <code>xyplot</code> methods also are useful for the space-time <code>Raster</code> objects:
</p>



<pre class="src src-R">horizonplot(SST)
</pre>


<p>
<img src="figs/horizon.png"  alt="figs/horizon.png" />
</p>
</div>

</div>

<div id="outline-container-vectorplot" class="outline-2">
<h2 id="vectorplot"><a name="sec-5" id="sec-5"></a>Vector field plots</h2>
<div class="outline-text-2" id="text-vectorplot">


<p>
The function <code>terrain</code> from <code>raster</code> provides the vector field
(gradient) from a scalar field stored in a <code>RasterLayer</code> object. The
magnitude (slope) and direction (aspect) of the vector field is
usually displayed with a set of arrows (e.g. <code>quiver</code> in Matlab).
</p>
<p>
<code>rasterVis</code> includes a method, <code>vectorplot</code>, to calculate and display
this vector field. 
</p>



<pre class="src src-R">proj <span class="org-constant">&lt;-</span> CRS(<span class="org-string">'+proj=longlat +datum=WGS84'</span>)
df <span class="org-constant">&lt;-</span> expand.grid(x=seq(-2, 2, .01), y=seq(-2, 2, .01))

df$z <span class="org-constant">&lt;-</span> with(df, (3*x^2 + y)*exp(-x^2-y^2))
r <span class="org-constant">&lt;-</span> rasterFromXYZ(df, crs=proj)
</pre>



<pre class="src src-R">vectorplot(r, par.settings=RdBuTheme())
</pre>


<p>
<img src="figs/vectorplot.png"  alt="figs/vectorplot.png" />
</p>
<p>
If the <code>Raster*</code> object passed to <code>vectorplot</code> is a
vector field (<code>isField=TRUE</code>), the <code>terrain</code> calculation is
skipped.
</p>
<p>
An alternative method to display a vector field plots streamlines
along the field lines. Streamlines, a family of curves that are
tangent to the vector field, show the direction an element
(<i>droplet</i>) will follow under the effect of the field.
<code>streamplot</code> displays streamlines with a procedure inspired
by the <a href="http://christl.cg.tuwien.ac.at/research/vis/dynsys/frolic/frolic_crc.pdf">FROLIC algorithm</a>: for each point
(<i>droplet</i>) of a jittered regular grid, a short streamline
portion (<i>streamlet</i>) is calculated by integrating the
underlying vector field at that point. The main color of each
streamlet indicates local vector magnitude
(<code>slope</code>). Besides, streamlets are composed of points whose sizes,
positions and color degradation encode the local vector direction
(<code>aspect</code>).
</p>



<pre class="src src-R">streamplot(r)
</pre>


<p>
<img src="figs/streamplot.png"  alt="figs/streamplot.png" />
</p>
<p>
<code>streamplot</code> accepts two arguments (<code>droplets</code> and <code>streamlets</code>)
to control the number of droplets, the length of the streamlets
and the streamlet calculation step. The streamlet colour
palette and the panel background color are defined with an
specific theme for <code>streamplot</code>, <code>streamTheme</code>. The default
options can be changed easily:
</p>



<pre class="src src-R">df$z <span class="org-constant">&lt;-</span> with(df, sqrt(x^2 + y^2))
df$phi <span class="org-constant">&lt;-</span> with(df, atan2(-y, x))
r2 <span class="org-constant">&lt;-</span> rasterFromXYZ(df, crs=proj)

streamplot(r2, isField=<span class="org-type">TRUE</span>, streamlet=list(L=30), droplet=list(pc=.3),
           par.settings=streamTheme(symbol=brewer.pal(n=5, name=<span class="org-string">'Reds'</span>)))

</pre>


<p>
<img src="figs/streamplotReds.png"  alt="figs/streamplotReds.png" />
</p>
</div>

</div>

<div id="outline-container-interaction" class="outline-2">
<h2 id="interaction"><a name="sec-6" id="sec-6"></a>Interaction</h2>
<div class="outline-text-2" id="text-interaction">


<p>
This package includes two functions to interact with the <code>trellis</code> objects. 
</p>
<p>
The <code>identifyRaster</code> method labels and returns points of a trellis graphic
according to mouse clicks. It is commonly used after <code>levelplot</code>,
although it can be also used after <code>xyplot</code>, <code>hexbinplot</code> or even <code>splom</code>:
</p>



<pre class="src src-R">levelplot(SISmm)

<span class="org-comment-delimiter">## </span><span class="org-comment">Do not close the last graphical window.  Use the left button of the</span>
<span class="org-comment-delimiter">## </span><span class="org-comment">mouse to identify points and the right button to finish</span>

chosen <span class="org-constant">&lt;-</span> identifyRaster(SISmm, layer=3, values=<span class="org-type">TRUE</span>)
</pre>


<p>
The <code>chooseRegion</code> function provides a set of points (in the form of a
<code>SpatialPoints</code> object) inside a region defined by several mouse
clicks. Use the left button of the mouse to build a border with points, and
the right button to finish.  The points enclosed by the border will
be highlighted and returned as a SpatialPoints object.
</p>



<pre class="src src-R">reg <span class="org-constant">&lt;-</span> chooseRegion()
</pre>



<hr/>


</div>
</div>
</div>

<div id="postamble">
<p class="date">Date: 2013-01-10 18:01:10 CET</p>
<p class="author">Author: Oscar Perpiñán Lamigueiro</p>
<p class="creator">Org version 7.8.11 with Emacs version 24</p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
